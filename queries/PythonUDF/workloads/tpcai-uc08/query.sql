EXPLAIN ANALYZE
WITH joined_data AS (
  SELECT
    o.o_order_id,
    o.date,
    li.quantity,
    p.department
  FROM orders o
  JOIN lineitem li ON o.o_order_id = li.li_order_id
  JOIN product p ON li.li_product_id = p.p_product_id
),

agg_counts AS (
  SELECT
    o_order_id,
    SUM(quantity) AS scan_count,
    SUM(ABS(quantity)) AS scan_count_abs
  FROM joined_data
  GROUP BY o_order_id
),

weekday_pivot AS (
  SELECT
    o_order_id,
    MAX(CASE WHEN DAYNAME(date) = 'Monday' THEN 1 ELSE 0 END) AS Monday,
    MAX(CASE WHEN DAYNAME(date) = 'Tuesday' THEN 1 ELSE 0 END) AS Tuesday,
    MAX(CASE WHEN DAYNAME(date) = 'Wednesday' THEN 1 ELSE 0 END) AS Wednesday,
    MAX(CASE WHEN DAYNAME(date) = 'Thursday' THEN 1 ELSE 0 END) AS Thursday,
    MAX(CASE WHEN DAYNAME(date) = 'Friday' THEN 1 ELSE 0 END) AS Friday,
    MAX(CASE WHEN DAYNAME(date) = 'Saturday' THEN 1 ELSE 0 END) AS Saturday,
    MAX(CASE WHEN DAYNAME(date) = 'Sunday' THEN 1 ELSE 0 END) AS Sunday
  FROM joined_data
  GROUP BY o_order_id
),

dept_pivot AS (
  SELECT
    o_order_id,
    SUM(CASE WHEN department = 'FINANCIAL SERVICES' THEN quantity ELSE 0 END) AS FINANCIAL_SERVICES,
    SUM(CASE WHEN department = 'SHOES' THEN quantity ELSE 0 END) AS SHOES,
    SUM(CASE WHEN department = 'PERSONAL CARE' THEN quantity ELSE 0 END) AS PERSONAL_CARE,
    SUM(CASE WHEN department = 'PAINT AND ACCESSORIES' THEN quantity ELSE 0 END) AS PAINT_AND_ACCESSORIES,
    SUM(CASE WHEN department = 'DSD GROCERY' THEN quantity ELSE 0 END) AS DSD_GROCERY,
    SUM(CASE WHEN department = 'MEAT - FRESH & FROZEN' THEN quantity ELSE 0 END) AS MEAT__FRESH__FROZEN,
    SUM(CASE WHEN department = 'DAIRY' THEN quantity ELSE 0 END) AS DAIRY,
    SUM(CASE WHEN department = 'PETS AND SUPPLIES' THEN quantity ELSE 0 END) AS PETS_AND_SUPPLIES,
    SUM(CASE WHEN department = 'HOUSEHOLD CHEMICALS/SUPP' THEN quantity ELSE 0 END) AS HOUSEHOLD_CHEMICALS_SUPP,
    SUM(CASE WHEN department = 'IMPULSE MERCHANDISE' THEN quantity ELSE 0 END) AS IMPULSE_MERCHANDISE,
    SUM(CASE WHEN department = 'PRODUCE' THEN quantity ELSE 0 END) AS PRODUCE,
    SUM(CASE WHEN department = 'CANDY, TOBACCO, COOKIES' THEN quantity ELSE 0 END) AS CANDY_TOBACCO_COOKIES,
    SUM(CASE WHEN department = 'GROCERY DRY GOODS' THEN quantity ELSE 0 END) AS GROCERY_DRY_GOODS,
    SUM(CASE WHEN department = 'BOYS WEAR' THEN quantity ELSE 0 END) AS BOYS_WEAR,
    SUM(CASE WHEN department = 'FABRICS AND CRAFTS' THEN quantity ELSE 0 END) AS FABRICS_AND_CRAFTS,
    SUM(CASE WHEN department = 'JEWELRY AND SUNGLASSES' THEN quantity ELSE 0 END) AS JEWELRY_AND_SUNGLASSES,
    SUM(CASE WHEN department = 'MENS WEAR' THEN quantity ELSE 0 END) AS MENS_WEAR,
    SUM(CASE WHEN department = 'ACCESSORIES' THEN quantity ELSE 0 END) AS ACCESSORIES,
    SUM(CASE WHEN department = 'HOME MANAGEMENT' THEN quantity ELSE 0 END) AS HOME_MANAGEMENT,
    SUM(CASE WHEN department = 'FROZEN FOODS' THEN quantity ELSE 0 END) AS FROZEN_FOODS,
    SUM(CASE WHEN department = 'SERVICE DELI' THEN quantity ELSE 0 END) AS SERVICE_DELI,
    SUM(CASE WHEN department = 'INFANT CONSUMABLE HARDLINES' THEN quantity ELSE 0 END) AS INFANT_CONSUMABLE_HARDLINES,
    SUM(CASE WHEN department = 'PRE PACKED DELI' THEN quantity ELSE 0 END) AS PRE_PACKED_DELI,
    SUM(CASE WHEN department = 'COOK AND DINE' THEN quantity ELSE 0 END) AS COOK_AND_DINE,
    SUM(CASE WHEN department = 'PHARMACY OTC' THEN quantity ELSE 0 END) AS PHARMACY_OTC,
    SUM(CASE WHEN department = 'LADIESWEAR' THEN quantity ELSE 0 END) AS LADIESWEAR,
    SUM(CASE WHEN department = 'COMM BREAD' THEN quantity ELSE 0 END) AS COMM_BREAD,
    SUM(CASE WHEN department = 'BAKERY' THEN quantity ELSE 0 END) AS BAKERY,
    SUM(CASE WHEN department = 'HOUSEHOLD PAPER GOODS' THEN quantity ELSE 0 END) AS HOUSEHOLD_PAPER_GOODS,
    SUM(CASE WHEN department = 'CELEBRATION' THEN quantity ELSE 0 END) AS CELEBRATION,
    SUM(CASE WHEN department = 'HARDWARE' THEN quantity ELSE 0 END) AS HARDWARE,
    SUM(CASE WHEN department = 'BEAUTY' THEN quantity ELSE 0 END) AS BEAUTY,
    SUM(CASE WHEN department = 'AUTOMOTIVE' THEN quantity ELSE 0 END) AS AUTOMOTIVE,
    SUM(CASE WHEN department = 'BOOKS AND MAGAZINES' THEN quantity ELSE 0 END) AS BOOKS_AND_MAGAZINES,
    SUM(CASE WHEN department = 'SEAFOOD' THEN quantity ELSE 0 END) AS SEAFOOD,
    SUM(CASE WHEN department = 'OFFICE SUPPLIES' THEN quantity ELSE 0 END) AS OFFICE_SUPPLIES,
    SUM(CASE WHEN department = 'LAWN AND GARDEN' THEN quantity ELSE 0 END) AS LAWN_AND_GARDEN,
    SUM(CASE WHEN department = 'SHEER HOSIERY' THEN quantity ELSE 0 END) AS SHEER_HOSIERY,
    SUM(CASE WHEN department = 'WIRELESS' THEN quantity ELSE 0 END) AS WIRELESS,
    SUM(CASE WHEN department = 'BEDDING' THEN quantity ELSE 0 END) AS BEDDING,
    SUM(CASE WHEN department = 'BATH AND SHOWER' THEN quantity ELSE 0 END) AS BATH_AND_SHOWER,
    SUM(CASE WHEN department = 'HORTICULTURE AND ACCESS' THEN quantity ELSE 0 END) AS HORTICULTURE_AND_ACCESS,
    SUM(CASE WHEN department = 'HOME DECOR' THEN quantity ELSE 0 END) AS HOME_DECOR,
    SUM(CASE WHEN department = 'TOYS' THEN quantity ELSE 0 END) AS TOYS,
    SUM(CASE WHEN department = 'INFANT APPAREL' THEN quantity ELSE 0 END) AS INFANT_APPAREL,
    SUM(CASE WHEN department = 'LADIES SOCKS' THEN quantity ELSE 0 END) AS LADIES_SOCKS,
    SUM(CASE WHEN department = 'PLUS AND MATERNITY' THEN quantity ELSE 0 END) AS PLUS_AND_MATERNITY,
    SUM(CASE WHEN department = 'ELECTRONICS' THEN quantity ELSE 0 END) AS ELECTRONICS,
    SUM(CASE WHEN department = 'GIRLS WEAR, 4-6X  AND 7-14' THEN quantity ELSE 0 END) AS GIRLS_WEAR_46X__AND_714,
    SUM(CASE WHEN department = 'BRAS & SHAPEWEAR' THEN quantity ELSE 0 END) AS BRAS__SHAPEWEAR,
    SUM(CASE WHEN department = 'LIQUOR,WINE,BEER' THEN quantity ELSE 0 END) AS LIQUORWINEBEER,
    SUM(CASE WHEN department = 'SLEEPWEAR/FOUNDATIONS' THEN quantity ELSE 0 END) AS SLEEPWEAR_FOUNDATIONS,
    SUM(CASE WHEN department = 'CAMERAS AND SUPPLIES' THEN quantity ELSE 0 END) AS CAMERAS_AND_SUPPLIES,
    SUM(CASE WHEN department = 'SPORTING GOODS' THEN quantity ELSE 0 END) AS SPORTING_GOODS,
    SUM(CASE WHEN department = 'PLAYERS AND ELECTRONICS' THEN quantity ELSE 0 END) AS PLAYERS_AND_ELECTRONICS,
    SUM(CASE WHEN department = 'PHARMACY RX' THEN quantity ELSE 0 END) AS PHARMACY_RX,
    SUM(CASE WHEN department = 'MENSWEAR' THEN quantity ELSE 0 END) AS MENSWEAR,
    SUM(CASE WHEN department = 'OPTICAL - FRAMES' THEN quantity ELSE 0 END) AS OPTICAL__FRAMES,
    SUM(CASE WHEN department = 'SWIMWEAR/OUTERWEAR' THEN quantity ELSE 0 END) AS SWIMWEAR_OUTERWEAR,
    SUM(CASE WHEN department = 'OTHER DEPARTMENTS' THEN quantity ELSE 0 END) AS OTHER_DEPARTMENTS,
    SUM(CASE WHEN department = 'MEDIA AND GAMING' THEN quantity ELSE 0 END) AS MEDIA_AND_GAMING,
    SUM(CASE WHEN department = 'FURNITURE' THEN quantity ELSE 0 END) AS FURNITURE,
    SUM(CASE WHEN department = 'OPTICAL - LENSES' THEN quantity ELSE 0 END) AS OPTICAL__LENSES,
    SUM(CASE WHEN department = 'SEASONAL' THEN quantity ELSE 0 END) AS SEASONAL,
    SUM(CASE WHEN department = 'LARGE HOUSEHOLD GOODS' THEN quantity ELSE 0 END) AS LARGE_HOUSEHOLD_GOODS,
    SUM(CASE WHEN department = '1-HR PHOTO' THEN quantity ELSE 0 END) AS HR_PHOTO,
    SUM(CASE WHEN department = 'CONCEPT STORES' THEN quantity ELSE 0 END) AS CONCEPT_STORES,
    SUM(CASE WHEN department = 'HEALTH AND BEAUTY AIDS' THEN quantity ELSE 0 END) AS HEALTH_AND_BEAUTY_AIDS
  FROM joined_data
  GROUP BY o_order_id
)

SELECT
  *
FROM agg_counts a
LEFT JOIN weekday_pivot wp ON a.o_order_id = wp.o_order_id
LEFT JOIN dept_pivot dp ON a.o_order_id = dp.o_order_id
WHERE
    predict (
    CAST(a.scan_count AS INT64),
    CAST(a.scan_count_abs AS INT64),
    CAST(COALESCE(wp.Friday, 0) AS FLOAT),
    CAST(COALESCE(wp.Monday, 0) AS FLOAT),
    CAST(COALESCE(wp.Saturday, 0) AS FLOAT),
    CAST(COALESCE(wp.Sunday, 0) AS FLOAT),
    CAST(COALESCE(wp.Thursday, 0) AS FLOAT),
    CAST(COALESCE(wp.Tuesday, 0) AS FLOAT),
    CAST(COALESCE(wp.Wednesday, 0) AS FLOAT),
    CAST(COALESCE(dp.AUTOMOTIVE, 0) AS FLOAT),
    CAST(COALESCE(dp.BAKERY, 0) AS FLOAT),
    CAST(COALESCE(dp.SHEER_HOSIERY, 0) AS FLOAT),
    CAST(COALESCE(dp.OTHER_DEPARTMENTS, 0) AS FLOAT),
    CAST(COALESCE(dp.FURNITURE, 0) AS FLOAT),
    CAST(COALESCE(dp.SWIMWEAR_OUTERWEAR, 0) AS FLOAT),
    CAST(COALESCE(dp.OPTICAL__FRAMES, 0) AS FLOAT),
    CAST(COALESCE(dp.ACCESSORIES, 0) AS FLOAT),
    CAST(COALESCE(dp.MENSWEAR, 0) AS FLOAT),
    CAST(COALESCE(dp.LARGE_HOUSEHOLD_GOODS, 0) AS FLOAT),
    CAST(COALESCE(dp.PLUS_AND_MATERNITY, 0) AS FLOAT),
    CAST(COALESCE(dp.LADIES_SOCKS, 0) AS FLOAT),
    CAST(COALESCE(dp.CONCEPT_STORES, 0) AS FLOAT),
    CAST(COALESCE(dp.OPTICAL__LENSES, 0) AS FLOAT),
    CAST(COALESCE(dp.HR_PHOTO, 0) AS FLOAT),
    CAST(COALESCE(dp.BOOKS_AND_MAGAZINES, 0) AS FLOAT),
    CAST(COALESCE(dp.BRAS__SHAPEWEAR, 0) AS FLOAT),
    CAST(COALESCE(dp.PRE_PACKED_DELI, 0) AS FLOAT),
    CAST(COALESCE(dp.SEAFOOD, 0) AS FLOAT),
    CAST(COALESCE(dp.HEALTH_AND_BEAUTY_AIDS, 0) AS FLOAT),
    CAST(COALESCE(dp.SLEEPWEAR_FOUNDATIONS, 0) AS FLOAT),
    CAST(COALESCE(dp.SEASONAL, 0) AS FLOAT),
    CAST(COALESCE(dp.CAMERAS_AND_SUPPLIES, 0) AS FLOAT),
    CAST(COALESCE(dp.BATH_AND_SHOWER, 0) AS FLOAT),
    CAST(COALESCE(dp.BEAUTY, 0) AS FLOAT),
    CAST(COALESCE(dp.BEDDING, 0) AS FLOAT),
    CAST(COALESCE(dp.BOYS_WEAR, 0) AS FLOAT),
    CAST(COALESCE(dp.CANDY_TOBACCO_COOKIES, 0) AS FLOAT),
    CAST(COALESCE(dp.CELEBRATION, 0) AS FLOAT),
    CAST(COALESCE(dp.COMM_BREAD, 0) AS FLOAT),
    CAST(COALESCE(dp.COOK_AND_DINE, 0) AS FLOAT),
    CAST(COALESCE(dp.DAIRY, 0) AS FLOAT),
    CAST(COALESCE(dp.DSD_GROCERY, 0) AS FLOAT),
    CAST(COALESCE(dp.ELECTRONICS, 0) AS FLOAT),
    CAST(COALESCE(dp.FABRICS_AND_CRAFTS, 0) AS FLOAT),
    CAST(COALESCE(dp.FINANCIAL_SERVICES, 0) AS FLOAT),
    CAST(COALESCE(dp.FROZEN_FOODS, 0) AS FLOAT),
    CAST(COALESCE(dp.GIRLS_WEAR_46X__AND_714, 0) AS FLOAT),
    CAST(COALESCE(dp.GROCERY_DRY_GOODS, 0) AS FLOAT),
    CAST(COALESCE(dp.HARDWARE, 0) AS FLOAT),
    CAST(COALESCE(dp.HOME_DECOR, 0) AS FLOAT),
    CAST(COALESCE(dp.HOME_MANAGEMENT, 0) AS FLOAT),
    CAST(COALESCE(dp.HORTICULTURE_AND_ACCESS, 0) AS FLOAT),
    CAST(COALESCE(dp.HOUSEHOLD_CHEMICALS_SUPP, 0) AS FLOAT),
    CAST(COALESCE(dp.HOUSEHOLD_PAPER_GOODS, 0) AS FLOAT),
    CAST(COALESCE(dp.IMPULSE_MERCHANDISE, 0) AS FLOAT),
    CAST(COALESCE(dp.INFANT_APPAREL, 0) AS FLOAT),
    CAST(COALESCE(dp.INFANT_CONSUMABLE_HARDLINES, 0) AS FLOAT),
    CAST(COALESCE(dp.JEWELRY_AND_SUNGLASSES, 0) AS FLOAT),
    CAST(COALESCE(dp.LADIESWEAR, 0) AS FLOAT),
    CAST(COALESCE(dp.LAWN_AND_GARDEN, 0) AS FLOAT),
    CAST(COALESCE(dp.LIQUORWINEBEER, 0) AS FLOAT),
    CAST(COALESCE(dp.MEAT__FRESH__FROZEN, 0) AS FLOAT),
    CAST(COALESCE(dp.MEDIA_AND_GAMING, 0) AS FLOAT),
    CAST(COALESCE(dp.MENS_WEAR, 0) AS FLOAT),
    CAST(COALESCE(dp.OFFICE_SUPPLIES, 0) AS FLOAT),
    CAST(COALESCE(dp.PAINT_AND_ACCESSORIES, 0) AS FLOAT),
    CAST(COALESCE(dp.PERSONAL_CARE, 0) AS FLOAT),
    CAST(COALESCE(dp.PETS_AND_SUPPLIES, 0) AS FLOAT),
    CAST(COALESCE(dp.PHARMACY_OTC, 0) AS FLOAT),
    CAST(COALESCE(dp.PHARMACY_RX, 0) AS FLOAT),
    CAST(COALESCE(dp.PLAYERS_AND_ELECTRONICS, 0) AS FLOAT),
    CAST(COALESCE(dp.PRODUCE, 0) AS FLOAT),
    CAST(COALESCE(dp.SERVICE_DELI, 0) AS FLOAT),
    CAST(COALESCE(dp.SHOES, 0) AS FLOAT),
    CAST(COALESCE(dp.SPORTING_GOODS, 0) AS FLOAT),
    CAST(COALESCE(dp.TOYS, 0) AS FLOAT),
    CAST(COALESCE(dp.WIRELESS, 0) AS FLOAT)
    ) = ?;